name: Build Zig Static (aarch64-musl)

on:
  workflow_dispatch:

jobs:
  build-zig:
    runs-on: ubuntu-latest

    steps:
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git cmake ninja-build python3 curl \
            build-essential \
            g++-aarch64-linux-gnu

          # Download musl toolchain
          mkdir -p /opt/musl
          curl -L https://musl.cc/aarch64-linux-musl-cross.tgz | tar xz -C /opt/musl
          echo "PATH=/opt/musl/bin:$PATH" >> $GITHUB_ENV

      - name: Clone zig-bootstrap
        uses: actions/checkout@v4
        with:
          repository: ziglang/zig-bootstrap
          path: zig-bootstrap

      - name: Build Zig for aarch64-linux-musl
        working-directory: zig-bootstrap
        env:
          CC: aarch64-linux-musl-gcc
          CXX: aarch64-linux-musl-g++
          AR: aarch64-linux-musl-ar
          RANLIB: aarch64-linux-musl-ranlib
          TARGET_TRIPLE: aarch64-linux-musl
        run: |
          ./build aarch64-linux-musl

      - name: Verify Build Output
        run: |
          file zig-bootstrap/out/zig-aarch64-linux-musl/zig
          ldd zig-bootstrap/out/zig-aarch64-linux-musl/zig || echo "Static binary verified"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: zig-aarch64-musl
          path: zig-bootstrap/out/zig-aarch64-linux-musl/
